<div style="margin: 1rem 0; font-family: monospace;">
  <span id="countdown">Calculatingâ€¦</span>
  &nbsp;&nbsp;|&nbsp;&nbsp;
  <label>
    Portfolio Balance: $
    <input id="balance"
           type="number"
           step="0.01"
           placeholder="0.00"
           style="width: 100px;" />
  </label>
</div>
<table id="master" border="1" width="100%">
  <thead>
    <tr>
      <th>Order book</th>
      <th>Info</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<style>
  #master td { vertical-align: top; }
</style>
<script>
  const ws = new WebSocket("ws://107.22.134.132:8000/ws");
  const rows = new Map();               // ticker â†’ <tr>
  const books = new Map();              // eventKey â†’ <table class=book>

  ws.onopen  = () => console.log("ðŸ“¡ connected");
  ws.onclose = () => console.log("âŒ closed");

  ws.onmessage = (evt) => {
    const { ticker, yes, no } = JSON.parse(evt.data);
    const { site, date, strike } = parseTicker(ticker);
    if (!strike) return;

    const eventKey = `${site}-${date}`;
    let book = books.get(eventKey);

    /* ---------- create or locate the site-day row ---------- */
    let siteRow = [...master.tBodies[0].rows].find(r => r.dataset.eventKey === eventKey);
    if (!siteRow) {
      siteRow = master.tBodies[0].insertRow();
      siteRow.dataset.eventKey = eventKey;

      /* left cell holds the orderbook table */
      const left = siteRow.insertCell();
      book = document.createElement('table');
      book.className = 'book';
      book.border = 1;
      book.style.width = '100%';
      book.appendChild(document.createElement('tbody'));
      left.appendChild(book);
      books.set(eventKey, book);

      /* right cell (empty for now) */
      siteRow.insertCell();
      siteRow.cells[0].style.width = '50%';
      siteRow.cells[1].style.width = '50%';
    }
    /* ------------------------------------------------------- */

    /* locate or create the strike row in the orderbook table */
    const tbody = book.tBodies[0];
    let tr = [...tbody.rows].find(r => r.dataset.ticker === ticker);
    if (tr) {
      tr.children[1].textContent = yes;
      tr.children[2].textContent = no;
    } else {
      tr = tbody.insertRow();
      tr.dataset.ticker = ticker;
      tr.innerHTML = `
        <td style="width:35ch;">${ticker}</td>
        <td style="width:10ch;">${yes}</td>
        <td style="width:10ch;">${no}</td>
      `;
    }

    /* keep strikes sorted numerically */
    [...tbody.children]
      .sort((a, b) => {
        const sa = parseFloat(a.children[0].textContent.match(/[TB]([\d.]+)/)[1]);
        const sb = parseFloat(b.children[0].textContent.match(/[TB]([\d.]+)/)[1]);
        return sa - sb;
      })
      .forEach(r => tbody.appendChild(r));
  };

  function parseTicker(raw) {
    const p = raw.split('-');
    return { site: p[0], date: p[1], strike: p[2] || null };
  }
</script>

<script>
/* ---------- countdown ---------- */
function fmt(n) { return n.toString().padStart(2, '0'); }

function updateCountdown() {
  const now = new Date();
  const target = new Date(now);

  // 3 AM Eastern.  EST/EDT is detected automatically by the browser.
  target.setHours(3, 0, 0, 0);

  // If weâ€™re already past 03:00 today â†’ target becomes 03:00 tomorrow
  if (now >= target) target.setDate(target.getDate() + 1);

  const diff = target - now;                // ms remaining
  const h = Math.floor(diff / 36e5);
  const m = Math.floor((diff % 36e5) / 6e4);
  const s = Math.floor((diff % 6e4)  / 1e3);

  document.getElementById('countdown').textContent =
    `Time to 3 AM EST: ${h}:${fmt(m)}:${fmt(s)}`;
}

updateCountdown();
setInterval(updateCountdown, 1000);

/* ---------- balance ---------- */
const balInput = document.getElementById('balance');

// load saved value on startup
balInput.value = localStorage.getItem('portfolioBalance') || '';

// save on change
balInput.addEventListener('input', () =>
  localStorage.setItem('portfolioBalance', balInput.value)
);
</script>
