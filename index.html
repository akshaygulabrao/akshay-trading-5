<div style="margin: 1rem 0; font-family: monospace;">
  <span id="countdown">Calculating‚Ä¶</span>
  &nbsp;&nbsp;|&nbsp;&nbsp;
  <label>
    Portfolio Balance: $
    <input id="balance"
           type="number"
           step="0.01"
           placeholder="0.00"
           style="width: 100px;" />
  </label>
</div>
<table id="messagesTable" border="1" style="border-collapse: collapse; width: 100%;">
  <thead>
    <tr>
      <th>Ticker</th>
      <th>Yes</th>
      <th>No</th>
    </tr>
  </thead>
  <tbody id="messagesBody">
  </tbody>
</table>


<script>
  const ws = new WebSocket("ws://107.22.134.132:8000/ws");
  const rows = new Map(); // ticker ‚Üí <tr>

  const tbody = document.getElementById("messagesBody");

  ws.onopen = () => {
    console.log("üì° connected");
  };

  ws.onmessage = (evt) => {
    const msg = JSON.parse(evt.data);
    const { ticker, yes, no } = msg;

    const { site, date, strike } = parseTicker(ticker);
    if (!strike) return;

    const eventKey = `${site}-${date}`;
    const tbody = ensureBody(eventKey);

    let tr = null;
    for (const row of tbody.rows) {
      if (row.children[0]?.textContent === ticker) {
        tr = row;
        break;
      }
    }

    if (tr) {
      tr.children[1].textContent = yes;
      tr.children[2].textContent = no;
    } else {
      tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${ticker}</td>
        <td>${yes}</td>
        <td>${no}</td>
      `;
      tbody.appendChild(tr);
    }

    /* ---------- sort rows numerically ---------- */
    const rows = Array.from(tbody.querySelectorAll('tr')).slice(1); // skip header
    rows.sort((a, b) => {
      const valA = parseFloat(a.children[0].textContent.match(/[TB](\d+(?:\.\d+)?)/)[0].replace(/[TB]/, ''));
      const valB = parseFloat(b.children[0].textContent.match(/[TB](\d+(?:\.\d+)?)/)[0].replace(/[TB]/, ''));
      return valA - valB;
    });

    // Re-append in sorted order
    rows.forEach(row => tbody.appendChild(row));
  };

  ws.onclose = () => {
    console.log("‚ùå closed");
  };
</script>

<script>
/* ---------- countdown ---------- */
function fmt(n) { return n.toString().padStart(2, '0'); }

function updateCountdown() {
  const now = new Date();
  const target = new Date(now);

  // 3 AM Eastern.  EST/EDT is detected automatically by the browser.
  target.setHours(3, 0, 0, 0);

  // If we‚Äôre already past 03:00 today ‚Üí target becomes 03:00 tomorrow
  if (now >= target) target.setDate(target.getDate() + 1);

  const diff = target - now;                // ms remaining
  const h = Math.floor(diff / 36e5);
  const m = Math.floor((diff % 36e5) / 6e4);
  const s = Math.floor((diff % 6e4)  / 1e3);

  document.getElementById('countdown').textContent =
    `Time to 3 AM EST: ${h}:${fmt(m)}:${fmt(s)}`;
}

updateCountdown();
setInterval(updateCountdown, 1000);

/* ---------- balance ---------- */
const balInput = document.getElementById('balance');

// load saved value on startup
balInput.value = localStorage.getItem('portfolioBalance') || '';

// save on change
balInput.addEventListener('input', () =>
  localStorage.setItem('portfolioBalance', balInput.value)
);
</script>
<script>
/* ---------- helpers ---------- */
function parseTicker(raw) {
  // raw = "KXHIGHNY-25JUL04-T82"  or  "KXHIGHNY-25JUL03"
  const parts = raw.split('-');
  return {
    site: parts[0],               // "KXHIGHNY"
    date: parts[1],               // "25JUL04"
    strike: parts[2] || null      // "T82"  (null for EventTicker)
  };
}

/* ---------- render layer ---------- */
const table = document.getElementById('messagesTable');
const bodies = new Map();   // "KXHIGHNY-25JUL03" ‚Üí <tbody>

function ensureBody(eventKey) {
  if (bodies.has(eventKey)) return bodies.get(eventKey);

  // create new tbody with its own header row
  const tbody = document.createElement('tbody');
  tbody.innerHTML = `
    <tr style="background:#f4f4f4;">
      <th colspan="3">${eventKey}</th>
    </tr>
  `;
  table.appendChild(tbody);
  bodies.set(eventKey, tbody);
  return tbody;
}

/* overwrite the original onmessage so we can group by event */
ws.onmessage = (evt) => {
  const msg = JSON.parse(evt.data);
  const { ticker, yes, no } = msg;

  const { site, date, strike } = parseTicker(ticker);
  if (!strike) return;                     // skip EventTicker itself
  const eventKey = `${site}-${date}`;

  const tbody = ensureBody(eventKey);

  let tr = null;
  for (const row of tbody.rows) {
    if (row.children[0]?.textContent === ticker) { tr = row; break; }
  }

  if (tr) {                               // update existing
    tr.children[1].textContent = yes;
    tr.children[2].textContent = no;
  } else {                                // insert new
    tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${ticker}</td>
      <td>${yes}</td>
      <td>${no}</td>
    `;
    tbody.appendChild(tr);
  }
};
</script>
