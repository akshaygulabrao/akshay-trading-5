<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="UTF-8"/>
  <title>Live Order-Book</title>

  <!-- ==========  STYLES  ========== -->
  <style>
    /* page layout */
    body {
      display: flex;
      flex-direction: column;   /* ‚Üê add this line */
      align-items: center;      /* keep it centered */
      margin: 0;
      padding: 20px;
      font-family: sans-serif;
    }

    /* top countdown / balance bar */
    #topBar {
      margin: 1rem 0;
      font-family: monospace;
    }
    #balance {
      width: 100px;
    }

    /* master table (outer grid) */
    #master {
      border: 1px solid black;
      border-collapse: collapse;
    }
    #master th,
    #master td {
      border: 1px solid black;
      padding: 4px 8px;
      text-align: center;
    }

    /* inner order-book tables */
    .book {
      border: none;
      border-collapse: collapse;
      margin: 0 auto 20px;     /* 20 px below each book */
    }
    .book td,
    .book th {
      border: none;
      padding: 2px 6px;
    }

    /* site-day header */
    .siteDayLabel {
      font-size: 1em;
      color: #000;
      margin: 8px 0 4px;       /* 8 px above, 4 px below */
    }
  </style>
</head>

<body>
  <!-- ==========  TOP BAR  ========== -->
  <div id="topBar">
    <span id="countdown">Calculating‚Ä¶</span>
    &nbsp;&nbsp;|&nbsp;&nbsp;
    <label>
      Portfolio Balance: $
      <input id="balance"
             type="number"
             step="0.01"
             placeholder="0.00"/>
    </label>
  </div>

  <!-- ==========  MASTER TABLE  ========== -->
  <table id="master">
    <thead><tr></tr></thead>
    <tbody></tbody>
  </table>

  <!-- ==========  JAVASCRIPT  ========== -->
  <script>
    /* ---------- WebSocket & Grid ---------- */
    const ws   = new WebSocket("ws://0.0.0.0:8000/ws");
    const rows = new Map();   // ticker ‚Üí <tr>
    const books= new Map();   // eventKey ‚Üí <table class=book>

    ws.onopen  = () => console.log("üì° connected");
    ws.onclose = () => console.log("‚ùå closed");  

ws.onmessage = (evt) => {
  const msg = JSON.parse(evt.data);

  /* ----  NEW: type check  ---- */
  if (msg.type === "orderbook") {
    const { ticker, yes, no } = msg.data;
    const { site, date, strike } = parseTicker(ticker);
    if (!strike) return;

    const siteKey = site;

    /* ---------- rest of your existing code ---------- */
    let siteRow = [...master.tBodies[0].rows]
                  .find(r => r.dataset.siteKey === siteKey);
    if (!siteRow) {
      siteRow = master.tBodies[0].insertRow();
      siteRow.dataset.siteKey = siteKey;
    }

    let dateCell = [...siteRow.cells]
                   .find(c => c.dataset.date === date);
    if (!dateCell) {
      dateCell = document.createElement('td');
      dateCell.dataset.date = date;
      dateCell.dataset.site = siteKey;

      const allCells = [...siteRow.cells];
      let insertBefore = null;
      for (const c of allCells) {
        if (new Date(date) > new Date(c.dataset.date) || c.dataset.date === 'site') {
          insertBefore = c;
          break;
        }
      }
      siteRow.insertBefore(dateCell, insertBefore);

      dateCell.innerHTML = `<div class="siteDayLabel">${site} ${date}</div>`;
      const book = document.createElement('table');
      book.className = 'book';
      dateCell.appendChild(book);
      books.set(`${site}-${date}`, book);
    }

    const book = books.get(`${site}-${date}`);
    const tbody = book.tBodies[0] || book.appendChild(document.createElement('tbody'));
    let tr = [...tbody.rows].find(r => r.dataset.ticker === ticker);
    if (tr) {
      tr.children[1].textContent = yes;
      tr.children[2].textContent = no;
    } else {
      tr = tbody.insertRow();
      tr.dataset.ticker = ticker;
      tr.innerHTML = `
        <td>${ticker}</td>
        <td>${yes}</td>
        <td>${no}</td>`;
    }

    [...tbody.children]
      .sort((a, b) => {
        const sa = parseFloat(a.children[0].textContent.match(/[TB]([\d.]+)/)[1]);
        const sb = parseFloat(b.children[0].textContent.match(/[TB]([\d.]+)/)[1]);
        return sa - sb;
      })
      .forEach(r => tbody.appendChild(r));

  } else if (msg.type == "graph") {
    msg.data.forEach(logDatum);
  } 
  else {
    console.log('Non-orderbook message:', msg);
  }
};

    function logDatum(d){
          console.log(d);
          const siteKey = d.forecasts.site;
          let siteRow = [...master.tBodies[0].rows]
                  .find(r => r.dataset.siteKey === d.forecasts.site);
          if (!siteRow) {
            siteRow = master.tBodies[0].insertRow();
            siteRow.dataset.siteKey = siteKey;
          }
          let dateCell = [...siteRow.cells]
                .find(c => c.dataset.date === 'site');
          if (!dateCell) {
            dateCell = document.createElement('td');
            dateCell.dataset.date = 'site';
            dateCell.dataset.site = siteKey;

            siteRow.appendChild(dateCell);
          }
          dateCell.id = `cell-${siteKey}`;
          dateCell.innerHTML = `<div class="siteDayLabel">${siteKey} </div>`;
          drawXYAxes(`#cell-${siteKey}`);

    }
function drawXYAxes(selector) {
  // 1. dimensions
  const margin = { top: 2, right: 2, bottom: 2, left: 2 };
  const width  = 50 - margin.left - margin.right;
  const height = 50 - margin.top  - margin.bottom;

  // 2. scales
  const x = d3.scaleLinear().domain([0, 1]).range([0, width]);
  const y = d3.scaleLinear().domain([0, 1]).range([height, 0]);

  // 3. svg (create once)
  const svg = d3.select(selector)
      .selectAll('svg.xy-plot')
      .data([null])
      .join('svg')
        .attr('class', 'xy-plot')
        .attr('width',  width  + margin.left + margin.right)
        .attr('height', height + margin.top  + margin.bottom);

  const g = svg.selectAll('g')
      .data([null])
      .join('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

  // 4. grid lines
  g.selectAll('line.grid')
      .data([
        { x1: 0, y1: y(0.5), x2: width,  y2: y(0.5) }, // horizontal
        { x1: x(0.5), y1: 0, x2: x(0.5), y2: height }  // vertical
      ])
      .join('line')
      .attr('class', 'grid')
      .attr('stroke', '#e0e0e0')
      .attr('stroke-width', 0.5)
      .attr('x1', d => d.x1)
      .attr('y1', d => d.y1)
      .attr('x2', d => d.x2)
      .attr('y2', d => d.y2);

  // 5. axes
  const xAxis = d3.axisBottom(x)
      .ticks(2)          // 0, 0.5, 1
      .tickSize(2)
      .tickFormat(d3.format('0.1f'));
  const yAxis = d3.axisLeft(y)
      .ticks(2)
      .tickSize(2)
      .tickFormat(d3.format('0.1f'));

  g.selectAll('g.x-axis')
      .data([null])
      .join('g')
      .attr('class', 'x-axis')
      .attr('transform', `translate(0,${height})`)
      .call(xAxis)
      .call(g => g.select('.domain').attr('stroke', '#aaa').attr('stroke-width', 1))
      .call(g => g.selectAll('.tick line').attr('stroke', '#aaa'))
      .call(g => g.selectAll('.tick text')
          .attr('fill', '#666')
          .attr('font-size', 3)
          .attr('text-anchor', 'middle'));

  g.selectAll('g.y-axis')
      .data([null])
      .join('g')
      .attr('class', 'y-axis')
      .call(yAxis)
      .call(g => g.select('.domain').attr('stroke', '#aaa').attr('stroke-width', 1))
      .call(g => g.selectAll('.tick line').attr('stroke', '#aaa'))
      .call(g => g.selectAll('.tick text')
          .attr('fill', '#666')
          .attr('font-size', 3)
          .attr('text-anchor', 'end'));

  // 6. diagonal line
  const line = d3.line()
      .x(d => x(d))
      .y(d => y(d));

  g.selectAll('path')
      .data([[0, 1]])
      .join('path')
      .attr('fill', 'none')
      .attr('stroke', '#0077b6')
      .attr('stroke-width', 1.5)
      .attr('d', line);
}
    function parseTicker(raw) {
      const p = raw.split('-');
      return { site: p[0], date: p[1], strike: p[2] || null };
    }

    /* ---------- Countdown to 3 AM EST ---------- */
    const fmt = n => n.toString().padStart(2,'0');

    function updateCountdown() {
      const now = new Date();
      const target = new Date(now);
      target.setHours(3,0,0,0);
      if (now >= target) target.setDate(target.getDate()+1);

      const diff = target - now;
      const h = Math.floor(diff / 36e5);
      const m = Math.floor((diff % 36e5) / 6e4);
      const s = Math.floor((diff % 6e4) / 1e3);

      document.getElementById('countdown').textContent =
        `Time to 3 AM EST: ${h}:${fmt(m)}:${fmt(s)}`;
    }
    updateCountdown();
    setInterval(updateCountdown,1000);

    /* ---------- Portfolio Balance ---------- */
    const balInput = document.getElementById('balance');
    balInput.value = localStorage.getItem('portfolioBalance') || '';
    balInput.addEventListener('input', () =>
      localStorage.setItem('portfolioBalance', balInput.value)
    );
  </script>
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
</body>
</html>
